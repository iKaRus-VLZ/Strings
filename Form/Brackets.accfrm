Version =20
VersionRequired =20
Checksum =296948108
Begin Form
    RecordSelectors = NotDefault
    NavigationButtons = NotDefault
    DividingLines = NotDefault
    AllowDesignChanges = NotDefault
    DefaultView =0
    ScrollBars =0
    RecordLocks =2
    TabularCharSet =204
    TabularFamily =0
    PictureAlignment =2
    DatasheetGridlinesBehavior =3
    GridY =10
    Width =6973
    DatasheetFontHeight =10
    ItemSuffix =81
    Left =3240
    Top =2190
    Right =9960
    Bottom =8175
    DatasheetGridlinesColor =12632256
    Tag ="BackColor=Light"
    RecSrcDt = Begin
        0x0c1477270c51e540
    End
    GUID = Begin
        0xb0e65907f1cc7b43b8223bc224de02c9
    End
    NameMap = Begin
        0x0acc0e5500000000000000000000000000000000000000000c00000005000000 ,
        0x0000000000000000000000000000
    End
    OnOpen ="[Event Procedure]"
    DatasheetFontName ="Arial"
    PrtMip = Begin
        0x6801000068010000680100006801000000000000201c0000e010000001000000 ,
        0x010000006801000000000000a10700000100000001000000
    End
    PrtDevMode = Begin
        0x00000000000000009061040800000000205662baf77f0000335c03baf77f0000 ,
        0x0104220b9c006c01032f00000100090000000000640001000f002c0102000100 ,
        0x2c010200000041340066870500000000feffffffffffffff25ddf8adff7f0000 ,
        0xc0c0c00000005802180000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000046500800 ,
        0x4d53414343455353000000000000000000000000000000000000000000000000 ,
        0xff3e03005802aa00ac00aa00ac00010000003100436f7572696572204e657700 ,
        0x0000000000000000000000000000000000000000010001000200000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000009600 ,
        0x4b002c0100800000
    End
    PrtDevNames = Begin
        0x080015001f000100000000000000000000000000000000000000000000000046 ,
        0x505231313a0000000000
    End
    OnResize ="[Event Procedure]"
    FilterOnLoad =0
    DatasheetGridlinesColor12 =12632256
    PrtDevModeW = Begin
        0x00004203000000000200000200000000c0a33f05000000000000000000000000 ,
        0x880742030000000029000029000000008807420300000000a0828b0500000000 ,
        0x0104220bdc006c01032f00000100090000000000640001000f002c0102000100 ,
        0x2c01020000004100340000000000000009031000000000000000000000000000 ,
        0x5002000000000000480200000000000001000000000000000000e20000000000 ,
        0x2500000000005802180000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000046500800 ,
        0x4d53414343455353000000000000000000000000000000000000000000000000 ,
        0xff3e03005802aa00ac00aa00ac00010000003100436f7572696572204e657700 ,
        0x0000000000000000000000000000000000000000010001000200000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000000009600 ,
        0x4b002c0100800000
    End
    PrtDevNamesW = Begin
        0x040011001b000100000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000046005000520031003100 ,
        0x3a0000000000000000000000
    End
    NoSaveCTIWhenDisabled =1
    Begin
        Begin Label
            BackStyle =0
            TextFontCharSet =204
            FontName ="Tahoma"
        End
        Begin Line
            BorderLineStyle =0
            Width =1701
        End
        Begin CommandButton
            TextFontCharSet =204
            Width =1701
            Height =283
            FontSize =8
            FontWeight =400
            ForeColor =-2147483630
            FontName ="Tahoma"
            BorderLineStyle =0
        End
        Begin CheckBox
            SpecialEffect =2
            BorderLineStyle =0
            LabelX =230
            LabelY =-30
        End
        Begin TextBox
            FELineBreak = NotDefault
            SpecialEffect =2
            OldBorderStyle =0
            TextFontCharSet =204
            BorderLineStyle =0
            Width =1701
            LabelX =-1701
            FontName ="Tahoma"
            AsianLineBreak =255
        End
        Begin ComboBox
            SpecialEffect =2
            TextFontCharSet =204
            BorderLineStyle =0
            Width =1701
            LabelX =-1701
            FontName ="Tahoma"
        End
        Begin Subform
            SpecialEffect =2
            BorderLineStyle =0
            Width =1701
            Height =1701
        End
        Begin FormHeader
            Height =623
            BackColor =-2147483633
            Name ="ЗаголовокФормы"
            Tag ="BackColor=Dark"
            GUID = Begin
                0x3c2f3698856a2f4bba6200f1c4b59bf6
            End
            Begin
                Begin Label
                    OverlapFlags =93
                    Left =103
                    Top =103
                    Width =6695
                    Height =454
                    FontSize =14
                    FontWeight =700
                    ForeColor =9605778
                    Name ="lblTitle2"
                    Caption ="Заголовок"
                    Tag ="FontColor=Grey"
                    GUID = Begin
                        0xd992407765a1cc40a16cf832fb07a736
                    End
                    LayoutCachedLeft =103
                    LayoutCachedTop =103
                    LayoutCachedWidth =6798
                    LayoutCachedHeight =557
                End
                Begin Label
                    OverlapFlags =223
                    Left =60
                    Top =60
                    Width =6695
                    Height =454
                    FontSize =14
                    FontWeight =700
                    Name ="lblTitle"
                    Caption ="Заголовок"
                    Tag ="FontColor=White"
                    GUID = Begin
                        0x2218aa345ce6df4ca0d0c2b1124b959c
                    End
                    LayoutCachedLeft =60
                    LayoutCachedTop =60
                    LayoutCachedWidth =6755
                    LayoutCachedHeight =514
                    ForeThemeColorIndex =0
                End
                Begin Line
                    OverlapFlags =87
                    SpecialEffect =5
                    Left =70
                    Top =510
                    Width =6835
                    Name ="Line01"
                    GUID = Begin
                        0xc007f2fe7e55544a9f08bc9255f9c2a6
                    End
                    LayoutCachedLeft =70
                    LayoutCachedTop =510
                    LayoutCachedWidth =6905
                    LayoutCachedHeight =510
                End
            End
        End
        Begin Section
            CanGrow = NotDefault
            Height =4537
            BackColor =-2147483633
            Name ="ОбластьДанных"
            GUID = Begin
                0xd944d8567badc24da1cfabc3fdadd3dc
            End
            Begin
                Begin TextBox
                    ScrollBars =2
                    OverlapFlags =87
                    TextAlign =1
                    IMESentenceMode =3
                    Left =1134
                    Top =60
                    Width =5361
                    Height =825
                    ColumnOrder =5
                    Name ="txtInput"
                    AfterUpdate ="[Event Procedure]"
                    GUID = Begin
                        0x49ac7d38272dc6418595a300c8c43bb9
                    End

                    LayoutCachedLeft =1134
                    LayoutCachedTop =60
                    LayoutCachedWidth =6495
                    LayoutCachedHeight =885
                    Begin
                        Begin Label
                            OverlapFlags =93
                            Left =60
                            Top =60
                            Width =1080
                            Height =240
                            FontWeight =700
                            Name ="Надпись18"
                            Caption ="Выражение:"
                            GUID = Begin
                                0x2b8a91f0424ac94fb4b6d639e1ad4f22
                            End
                            LayoutCachedLeft =60
                            LayoutCachedTop =60
                            LayoutCachedWidth =1140
                            LayoutCachedHeight =300
                        End
                    End
                End
                Begin CommandButton
                    OverlapFlags =85
                    Left =6565
                    Top =85
                    Width =340
                    Height =340
                    TabIndex =1
                    Name ="cmdNew"
                    Caption ="..."
                    OnClick ="[Event Procedure]"
                    PictureData = Begin
                        0x2800000010000000100000000100040000000000800000000000000000000000 ,
                        0x0000000000000000000000000000800000800000008080008000000080008000 ,
                        0x8080000080808000c0c0c0000000ff00c0c0c00000ffff00ff000000c0c0c000 ,
                        0xffff0000ffffff00dadadadadadadada00a00d00adadadad00d00a00dadadada ,
                        0xadadadadadadadaddadadadadadadadaadadadadadadad00dadad7dadadad000 ,
                        0xa7ad7c7dadad000d7c7ad7dadad000daa7adadadad000daddadadadad000dada ,
                        0xada7adad000dadadda7c7ad000dadadaada7ad0b0dadadaddadad0b0dadadada ,
                        0xadada70dadadadad
                    End
                    ObjectPalette = Begin
                        0x000301000000000000000000
                    End
                    ControlTipText ="Нажми меня!"
                    GUID = Begin
                        0xc44e005c59c7354aa390d6633851d3c2
                    End

                    LayoutCachedLeft =6565
                    LayoutCachedTop =85
                    LayoutCachedWidth =6905
                    LayoutCachedHeight =425
                    WebImagePaddingLeft =2
                    WebImagePaddingTop =2
                    WebImagePaddingRight =1
                    WebImagePaddingBottom =1
                    Overlaps =1
                End
                Begin Line
                    OverlapFlags =85
                    SpecialEffect =5
                    Left =70
                    Top =1815
                    Width =6835
                    Name ="Line02"
                    GUID = Begin
                        0x93140c9a0b873e4892e91a641f185391
                    End
                    LayoutCachedLeft =70
                    LayoutCachedTop =1815
                    LayoutCachedWidth =6905
                    LayoutCachedHeight =1815
                End
                Begin TextBox
                    TabStop = NotDefault
                    OverlapFlags =93
                    TextAlign =1
                    IMESentenceMode =3
                    Left =1134
                    Top =930
                    Width =5361
                    Height =495
                    ColumnOrder =2
                    TabIndex =2
                    Name ="txtTemp"
                    AfterUpdate ="[Event Procedure]"
                    GUID = Begin
                        0x1a92c9928c071040ae263fcac7857a09
                    End

                    LayoutCachedLeft =1134
                    LayoutCachedTop =930
                    LayoutCachedWidth =6495
                    LayoutCachedHeight =1425
                End
                Begin CheckBox
                    OverlapFlags =85
                    Left =6235
                    Top =1530
                    Height =230
                    ColumnOrder =3
                    TabIndex =3
                    Name ="chkEval"
                    AfterUpdate ="[Event Procedure]"
                    GUID = Begin
                        0xb832883457937246a1eddfec6fc1c272
                    End

                    LayoutCachedLeft =6235
                    LayoutCachedTop =1530
                    LayoutCachedWidth =6495
                    LayoutCachedHeight =1760
                    Begin
                        Begin Label
                            OverlapFlags =85
                            TextAlign =1
                            Left =4605
                            Top =1530
                            Width =1560
                            Height =240
                            Name ="Надпись71"
                            Caption ="CretePlaceHolders"
                            GUID = Begin
                                0xcba14970255e42449100472094632d77
                            End
                            LayoutCachedLeft =4605
                            LayoutCachedTop =1530
                            LayoutCachedWidth =6165
                            LayoutCachedHeight =1770
                        End
                    End
                End
                Begin CheckBox
                    Visible = NotDefault
                    OverlapFlags =85
                    Left =4140
                    Top =1530
                    Width =200
                    Height =230
                    ColumnOrder =4
                    TabIndex =4
                    Name ="chkOnRun"
                    AfterUpdate ="[Event Procedure]"
                    DefaultValue ="False"
                    GUID = Begin
                        0xdc2379c18c4b714a9c9d5e6b984b8ef8
                    End

                    LayoutCachedLeft =4140
                    LayoutCachedTop =1530
                    LayoutCachedWidth =4340
                    LayoutCachedHeight =1760
                    Begin
                        Begin Label
                            OverlapFlags =85
                            TextAlign =1
                            Left =3915
                            Top =1530
                            Width =210
                            Height =240
                            Name ="Надпись73"
                            Caption ="OnRun"
                            GUID = Begin
                                0xaef45d936d67f94cab5b0fe19256c01d
                            End
                            LayoutCachedLeft =3915
                            LayoutCachedTop =1530
                            LayoutCachedWidth =4125
                            LayoutCachedHeight =1770
                        End
                    End
                End
                Begin Label
                    OverlapFlags =215
                    Left =60
                    Top =930
                    Width =1080
                    Height =240
                    FontWeight =700
                    Name ="Надпись75"
                    Caption ="Шаблоны:"
                    GUID = Begin
                        0x6ae838156e9b0a4d96a5cbcfac7b309c
                    End
                    LayoutCachedLeft =60
                    LayoutCachedTop =930
                    LayoutCachedWidth =1140
                    LayoutCachedHeight =1170
                End
                Begin TextBox
                    TabStop = NotDefault
                    OverlapFlags =87
                    TextAlign =1
                    IMESentenceMode =3
                    Left =1134
                    Top =1530
                    Width =622
                    ColumnOrder =0
                    TabIndex =5
                    Name ="txtTermDelim"
                    GUID = Begin
                        0x2fb913ba3334f5449b635c83fd5f4b2b
                    End

                    LayoutCachedLeft =1134
                    LayoutCachedTop =1530
                    LayoutCachedWidth =1756
                    LayoutCachedHeight =1770
                    Begin
                        Begin Label
                            OverlapFlags =93
                            TextAlign =1
                            Left =60
                            Top =1530
                            Width =1080
                            Height =240
                            Name ="Надпись77"
                            Caption ="Элемент"
                            GUID = Begin
                                0x36086f13128b5e4994cc597473292515
                            End
                            LayoutCachedLeft =60
                            LayoutCachedTop =1530
                            LayoutCachedWidth =1140
                            LayoutCachedHeight =1770
                        End
                    End
                End
                Begin TextBox
                    TabStop = NotDefault
                    OverlapFlags =87
                    TextAlign =1
                    IMESentenceMode =3
                    Left =2889
                    Top =1530
                    Width =622
                    ColumnOrder =1
                    TabIndex =6
                    Name ="txtTempDelim"
                    GUID = Begin
                        0x54e137ae90230448818bfa529049cbbe
                    End

                    LayoutCachedLeft =2889
                    LayoutCachedTop =1530
                    LayoutCachedWidth =3511
                    LayoutCachedHeight =1770
                    Begin
                        Begin Label
                            OverlapFlags =93
                            TextAlign =1
                            Left =1815
                            Top =1530
                            Width =1065
                            Height =240
                            Name ="Надпись79"
                            Caption ="Разделитель"
                            GUID = Begin
                                0x8e0936084440a3479075e3b6734cfdb8
                            End
                            LayoutCachedLeft =1815
                            LayoutCachedTop =1530
                            LayoutCachedWidth =2880
                            LayoutCachedHeight =1770
                        End
                    End
                End
                Begin Subform
                    OverlapFlags =85
                    Left =70
                    Top =2396
                    Width =6835
                    Height =2141
                    TabIndex =7
                    Name ="ctlData"
                    GUID = Begin
                        0xe122a5ca15edc24f96007e2a69da2e91
                    End

                    LayoutCachedLeft =70
                    LayoutCachedTop =2396
                    LayoutCachedWidth =6905
                    LayoutCachedHeight =4537
                End
                Begin ComboBox
                    RowSourceTypeInt =1
                    OldBorderStyle =0
                    OverlapFlags =95
                    IMESentenceMode =3
                    Left =380
                    Top =2114
                    TabIndex =8
                    GUID = Begin
                        0xa2b155605b96db41afa55633054fe062
                    End
                    Name ="txtIdx"
                    RowSourceType ="Value List"
                    AfterUpdate ="[Event Procedure]"

                    LayoutCachedLeft =380
                    LayoutCachedTop =2114
                    LayoutCachedWidth =2081
                    LayoutCachedHeight =2354
                    Begin
                        Begin Label
                            OverlapFlags =93
                            Left =380
                            Top =1860
                            Width =1701
                            Height =240
                            Name ="Надпись54"
                            Caption ="Индекс параметра"
                            GUID = Begin
                                0xa70af52bb1d45443aede7e66a5de71cc
                            End
                            LayoutCachedLeft =380
                            LayoutCachedTop =1860
                            LayoutCachedWidth =2081
                            LayoutCachedHeight =2100
                        End
                    End
                End
                Begin TextBox
                    OverlapFlags =87
                    IMESentenceMode =3
                    Left =2081
                    Top =2114
                    Width =4824
                    TabIndex =9
                    Name ="txtVal"
                    AfterUpdate ="[Event Procedure]"
                    GUID = Begin
                        0xcdfeebb50cb60b48a1f692104cb2a21c
                    End

                    LayoutCachedLeft =2081
                    LayoutCachedTop =2114
                    LayoutCachedWidth =6905
                    LayoutCachedHeight =2354
                    Begin
                        Begin Label
                            OverlapFlags =95
                            Left =2081
                            Top =1860
                            Width =4824
                            Height =240
                            Name ="Надпись55"
                            Caption ="Значение параметра"
                            GUID = Begin
                                0x6fbd6b0a06dfdf4fbff5921aa3ab15c9
                            End
                            LayoutCachedLeft =2081
                            LayoutCachedTop =1860
                            LayoutCachedWidth =6905
                            LayoutCachedHeight =2100
                        End
                    End
                End
            End
        End
        Begin FormFooter
            Height =1080
            BackColor =-2147483633
            Name ="ПримечаниеФормы"
            GUID = Begin
                0x9e5c1a82f5fe08438d129c6461478962
            End
            Begin
                Begin Label
                    OverlapFlags =85
                    Left =90
                    Top =60
                    Width =6695
                    Height =990
                    Name ="lblComment"
                    Caption ="Комментарий"
                    GUID = Begin
                        0xa98eaeead78b4c40bb77332789f4a280
                    End
                    LayoutCachedLeft =90
                    LayoutCachedTop =60
                    LayoutCachedWidth =6785
                    LayoutCachedHeight =1050
                End
                Begin Line
                    OverlapFlags =85
                    SpecialEffect =5
                    Left =70
                    Top =29
                    Width =6835
                    Name ="Line03"
                    GUID = Begin
                        0x9370583434f0b04ab9cf7178b389a9ac
                    End
                    LayoutCachedLeft =70
                    LayoutCachedTop =29
                    LayoutCachedWidth =6905
                    LayoutCachedHeight =29
                End
            End
        End
    End
End
CodeBehindForm
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Compare Database
Option Explicit
Private Const c_strTitle = "Разбор скобок в выражениях"
Private Const c_strComment = "Демонстрирует работу с выражениями со скобками." & vbCrLf & _
                             "Используется функция: GroupsGet для разбора выражений в скобках." & vbCrLf & _
                             "Группа может содержать вложенные группы поэтому изменение содержимого таким способом - сомнительная идея, " & _
                             "но в целях однообразия и немного для эксперимента - сделаем такую возможность, причём - тупо в лоб, заменой по позициям."
Private Const c_strLink = ""
Private Const Indent = 70 '0.125 * cm   ' отступ от края формы и расстояние между контролами
Private Const Offset = 2

Private Const c_lngScroll = 13.75 * pt
Private Const c_lngRecSel = 19 * pt
Private Const c_lngTagDelim = 0.75 * cm
Private iMin As Byte, iMax As Byte, iStep As Byte

Private m_bytState As Byte
Private WithEvents frmData As Access.Form
Attribute frmData.VB_VarHelpID = -1
Private adoRst  As Object 'ADODB.Recordset  'WithEvents adoRst  As ADODB.Recordset
Const adInteger = 3, adVarChar = 200
Private Const c_strFieldIdx = "TextIdx", c_strFieldVal = "TextVal"

Private cGroups As Collection
Private aGroups ' уровень/позиции элементов группы (см. GroupsGet)
Private Const gStep = 7         ' шаг элементов массива позиций элементов
    ' +0    '(.TextLev) уровень вложенности (0-вне скобок, 1-внешние скобки, ... n-скобки n-уровня)
    ' +1    '(.TextBeg) позиция начала текста подстроки в исходной строке (после открывающей скобки)
    ' +2    '(.TextEnd) позиция конца текста подстроки в исходной строке (до закрывающей скобки)
    ' +3    '(.TempBeg) позиция начала подстроки в исходной строке (включая скобки)
    ' +4    '(.TempEnd) позиция конца подстроки в исходной строке (включая скобки)
    ' +5    '(.TempNum) номер шаблона по массиву
    ' +6    '(.TempItm) номер элемента в шаблоне

Private Function Samples()
' массив данных для примера
' Элемент массива: [i+0]=Expression, [i+1]=Templates, [i+2]=TermDelim, [i+3]=TempDelim, [i+4]=UsePlaceHolders
    iStep = 5
    Samples = Array( _
        "5*((10-7)+[4])", _
            "(@)", _
            "@", ";", False, _
        "текст: ""первое {слово} дороже <*второго*>""", _
            "[%@%];<*@*>;(@);[@];{@};<@>;%@%;'@';""@""", _
            "@", ";", True, _
        "Do: If True Then 1 Else 0 End If: Loop", _
            "If @ Then @ Else @ End If;Do: @: Loop", _
            "@", ";", True _
        )
End Function

Private Sub Form_Open(Cancel As Integer)
Const cShadow = 0.075 * cm
    lblTitle.Caption = c_strTitle: lblTitle2.Caption = lblTitle.Caption: lblTitle2.Left = lblTitle.Left + cShadow: lblTitle2.Top = lblTitle.Top + cShadow
    lblComment.Caption = c_strComment
    'lblLink.Caption = c_strLink: lblLink.HyperlinkAddress = c_strLink
    InsideHeight = Section(acDetail).Height + Section(acHeader).Height + Section(acFooter).Height
' начальные значения
    ctlData.SourceObject = "subDelimitedText"
    With ctlData.Form
        .OnCurrent = c_strCustomProc
        .AfterUpdate = c_strCustomProc
        '.BeforeInsert = c_strCustomProc
        .OnDelete = c_strCustomProc
    End With
    Set frmData = ctlData.Form
    iMin = LBound(Samples): iMax = UBound(Samples)
    chkOnRun = False
    txtIdx.Left = Indent
    txtVal.Left = txtIdx.Left + txtIdx.Width '+ Indent
    frmData.Width = txtVal.Left + txtVal.Width '-c_lngScroll-Indent
    m_bytState = p_SwitchSamples(iMin)
    Form_Resize
End Sub
Private Sub Form_Resize()
' обрабатываем изменение границ
    On Error Resume Next 'GoTo HandleError
Dim tmpWidth As Long:   tmpWidth = Me.InsideWidth '- ConvPixelsToTwips(rct.Right - rct.Left)
Dim i As Long
    For i = 1 To 9
        With Controls("Line" & Format$(i, "00"))
            If Err Then Err.Clear Else .Left = Indent: .Width = tmpWidth - 2 * Indent
        End With
    Next i
' ресайзим дополнительные контролы по форме
    With lblTitle:      .Width = tmpWidth - 4 * Indent: End With
    With lblTitle2:     .Width = tmpWidth - 4 * Indent: End With
    With lblComment:    .Width = tmpWidth - 4 * Indent: End With
    
    With cmdNew:    .Left = InsideWidth - .Width - Indent: End With
    With txtInput:  .Width = cmdNew.Left - .Left - Indent: End With
    With txtTemp:   .Width = cmdNew.Left - .Left - Indent: End With
'    With txtResult: .Width = cmdNew.Left - .Left - Indent: End With
    With chkEval:   .Left = txtInput.Left + txtInput.Width - .Width: End With
    With chkEval.Controls(0): .Left = .PARENT.Left - .Width - Indent: End With
    
    With txtIdx:    .Left = IIf(frmData.RecordSelectors, c_lngRecSel, Indent):   End With
    With txtIdx.Controls(0): .Left = .PARENT.Left: .Width = .PARENT.Width: End With
    With txtVal:    .Left = txtIdx.Left + txtIdx.Width: .Width = InsideWidth - .Left - Indent: End With
    With txtVal.Controls(0): .Left = .PARENT.Left: .Width = .PARENT.Width: End With
    With ctlData: .Width = InsideWidth - .Left - Indent: .Height = (InsideHeight - Section(acHeader).Height - Section(acFooter).Height) - .Top: .Left = Indent: End With  ': .Top = Indent: End With
    With frmData: .txtIdx.Left = 0: .txtIdx.Width = txtIdx.Width: .txtVal.Left = txtIdx.Width: .txtVal.Width = txtVal.Width - IIf((.ScrollBars And 2) = 2, c_lngScroll, 0): End With
HandleExit: Exit Sub
HandleError: Select Case Err.Number
    Case 2100 ' Элемент не может быть размещен в указанном месте
'        Section(acDetail).Height = Section(acDetail).Height + 2 * Indent
    Case Else: Stop
    End Select
    Err.Clear: Resume HandleExit
End Sub
Private Sub cmdNew_Click(): m_bytState = p_SwitchSamples(m_bytState + iStep): End Sub
Private Sub txtInput_AfterUpdate():     p_UpdateResult: End Sub
Private Sub txtLBr_AfterUpdate():       p_UpdateResult: End Sub
Private Sub txtRBr_AfterUpdate():       p_UpdateResult: End Sub
Private Sub chkEval_AfterUpdate():      p_UpdateData: End Sub
Private Sub chkOnRun_AfterUpdate():     p_UpdateData: End Sub
Private Sub txtParams_AfterUpdate():    p_UpdateData: End Sub
Private Sub txtTempDelim_AfterUpdate(): p_UpdateData: End Sub
Private Sub txtTermDelim_AfterUpdate(): p_UpdateData: End Sub
Private Sub txtTagDelim_AfterUpdate():  p_UpdateData: End Sub
Private Sub txtIdx_AfterUpdate(): Call ItemSelect(txtIdx): p_GotoItem (txtIdx): End Sub
Private Sub txtVal_AfterUpdate(): Call ItemUpdate(txtIdx, txtVal): frmData.txtVal = txtVal: End Sub
Private Sub frmData_Current(): ItemSelect frmData.txtIdx: End Sub
'Private Sub frmData_BeforeInsert(Cancel As Integer): Cancel = Not ItemUpdate(frmData.txtIdx, frmData.txtVal): End Sub
Private Sub frmData_Delete(Cancel As Integer): Cancel = Not ItemDelete(frmData.txtIdx): End Sub
Private Sub frmData_AfterUpdate(): Call ItemUpdate(frmData.txtIdx, frmData.txtVal): End Sub

Private Function p_SwitchSamples(ByRef i As Byte) As Byte
    If i < iMin Or i > iMax Then i = iMin
    txtInput.Value = Samples(i)
    txtTemp.Value = Samples(i + 1)
    txtTermDelim.Value = Samples(i + 2)
    txtTempDelim.Value = Samples(i + 3)
    chkEval = Samples(i + 4)
    p_UpdateData
    p_SwitchSamples = i
End Function
Private Sub p_UpdateData() 'Optional ByVal Idx)
Dim strSource As String
Dim vIdx
Dim i As Long
    ' создаем запрос подчинённой формы
    Set adoRst = Nothing
    Set adoRst = CreateObject("ADODB.Recordset"): With adoRst: .Fields.Append c_strFieldIdx, adVarChar, 255: .Fields.Append c_strFieldVal, adVarChar, 255: .Open: End With
    If Len(Nz(txtTempDelim, vbNullString)) = 0 Then txtTempDelim = ";"
    If Len(Nz(txtTermDelim, vbNullString)) = 0 Then txtTermDelim = "@"
    Call GroupsGet(txtInput.Value, cGroups, chkEval.Value, txtTemp.Value, txtTermDelim.Value, txtTempDelim.Value, aGroups)
Dim vVal, aTag() As String, tMin As Long, tMax As Long
    strSource = vbNullString
    For i = LBound(aGroups) To UBound(aGroups) \ gStep
        vIdx = i: vVal = cGroups(i)
        strSource = strSource & ";" & i
        With adoRst: .AddNew: .Fields(c_strFieldIdx).Value = vIdx: .Fields(c_strFieldVal).Value = vVal: .UpdateBatch: End With
    Next i
    strSource = Mid$(strSource, 2)
' заполняем данные подчинённой формы (сбивает Idx)
    Set frmData.Recordset = adoRst
    frmData.Refresh ': Me.Refresh
' заполняем поле списка индексов (порядковый номер или имя параметра строки)
    With txtIdx: .RowSourceType = "Value List": .RowSource = strSource: .Visible = True: End With
' выбираем значение
    adoRst.MoveFirst ' Else Call ItemSelect(Idx)
    p_UpdateResult
End Sub
Private Sub p_UpdateResult()
    On Error GoTo HandleError
    ItemSelect (txtIdx)
HandleExit:  Exit Sub
HandleError: Err.Clear: Resume HandleExit
End Sub
Public Function ItemSelect(idx) As Boolean
    On Error GoTo HandleError
Dim strValue As String
Dim sBeg As Long, sEnd As Long
Dim Result As Boolean
Dim i As Long: i = CLng(idx)
    Result = False
    On Error GoTo HandleError
    strValue = cGroups(i)
' выделяем фрагмент в исходной строке
Dim g As Long: g = (i - 1) * gStep + 1
    With txtInput: .SetFocus: .SelStart = aGroups(g + 1) - 1: .SelLength = aGroups(g + 2) - aGroups(g + 1): End With
    txtIdx.Value = idx: txtVal.Value = strValue:
    Result = True
HandleExit:  ItemSelect = Result: Exit Function
HandleError: Result = False: strValue = vbNullString: Err.Clear: Resume HandleExit
End Function
Public Function ItemUpdate(idx, NewValue As String) As Boolean
Dim Result As Boolean ' Result = False
    On Error GoTo HandleError
' получаем значение
Dim g As Long: g = (idx - 1) * gStep + 1
Dim sBeg As Long: sBeg = aGroups(g + 1) - 1
Dim sEnd As Long: sEnd = aGroups(g + 2)
' плохая идея:
Dim strValue As String: strValue = txtInput.Value
    strValue = Left(strValue, sBeg) & NewValue & Mid(strValue, sEnd, Len(strValue) - sEnd + 1)
    txtInput.Value = strValue
    p_UpdateData
    Result = True
HandleExit:    ItemUpdate = Result: Exit Function
HandleError:   Result = False: strValue = vbNullString: Err.Clear: Resume HandleExit
End Function
Public Function ItemDelete(iNum As Integer) As Boolean

End Function
Private Function p_GotoItem(idx As String)
' выделяем фрагмент в списке
Dim rst: Set rst = adoRst.Clone
Dim Result As Boolean
    Result = False
    On Error GoTo HandleError
    rst.MoveFirst
    rst.Find "[" & c_strFieldIdx & "]='" & idx & "'" ', 1, 1
    adoRst.Bookmark = rst.Bookmark
    Result = True
HandleExit:  p_GotoItem = Result: Exit Function
HandleError: Result = False: Err.Clear: Resume HandleExit
End Function